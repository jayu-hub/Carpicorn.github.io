<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ChatBot - Capricorn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: transparent; }
        #chat-messages::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .message-animation { animation: slideIn 0.4s ease-out forwards; }
        #aurora-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background-color: #111827;
            background-image: radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 1) 0px, transparent 50%), 
                              radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 1) 0px, transparent 50%),
                              radial-gradient(at 52% 99%, hsla(355, 98%, 61%, 1) 0px, transparent 50%),
                              radial-gradient(at 10% 29%, hsla(256, 96%, 67%, 1) 0px, transparent 50%),
                              radial-gradient(at 97% 96%, hsla(38, 60%, 74%, 1) 0px, transparent 50%),
                              radial-gradient(at 33% 50%, hsla(222, 67%, 73%, 1) 0px, transparent 50%),
                              radial-gradient(at 79% 53%, hsla(343, 68%, 79%, 1) 0px, transparent 50%);
            z-index: -1; filter: blur(80px); opacity: 0.6;
        }
        .mic-listening { box-shadow: 0 0 20px 5px rgba(192, 132, 252, 0.7); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-900 text-white">

    <div id="aurora-bg"></div>

    <div class="flex flex-col w-full max-w-2xl h-[95vh] md:h-[85vh] max-h-[800px] bg-black/30 backdrop-blur-xl rounded-2xl shadow-2xl shadow-black/30 m-4 border border-white/20">
        <!-- Header -->
        <div class="p-4 rounded-t-2xl flex items-center justify-between border-b border-white/10">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-300"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                <h1 class="text-2xl font-bold text-white/90">Capricorn</h1>
            </div>
            <!-- Speaker Toggle Button -->
            <button id="speaker-btn" class="text-white/70 hover:text-white transition">
                <svg id="speaker-on-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                <svg id="speaker-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 p-6 overflow-y-auto space-y-4">
            <div class="flex items-start gap-3 message-animation">
                <div class="bg-purple-500/50 text-white p-2 rounded-full flex-shrink-0 shadow-lg border border-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </div>
                <div class="bg-white/20 p-3 rounded-lg rounded-tl-none max-w-md shadow-md border border-white/10">
                    <p class="text-white/90">Hey dude what's up i am Capricorn. Ask me anything, or press the microphone to talk.</p>
                </div>
            </div>
        </div>

        <!-- Message Input -->
        <div class="p-4 border-t border-white/10">
            <form id="chat-form" class="flex items-center gap-3">
                <input type="text" id="user-input" placeholder="Ask a question or use the mic..." class="flex-1 p-3 border-0 bg-black/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 text-white placeholder-gray-400 transition" autocomplete="off">
                <!-- Microphone Button -->
                <button type="button" id="mic-btn" class="text-white p-3 rounded-lg bg-purple-600/50 hover:bg-purple-600/80 transition shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                </button>
                <button type="submit" class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-500 active:bg-purple-700 transition-transform transform active:scale-95 focus:outline-none focus:ring-2 focus:ring-purple-400 disabled:bg-gray-500 disabled:cursor-not-allowed shadow-lg hover:shadow-purple-500/50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const submitButton = chatForm.querySelector('button[type="submit"]');
        const micBtn = document.getElementById('mic-btn');
        const speakerBtn = document.getElementById('speaker-btn');
        const speakerOnIcon = document.getElementById('speaker-on-icon');
        const speakerOffIcon = document.getElementById('speaker-off-icon');

        const BACKEND_URL = 'https://carpicorn-github-io.onrender.com';
        let isMuted = false;

        // --- TEXT-TO-SPEECH (TTS) ---
        function speakText(text) {
            if (isMuted || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel(); // Stop any previous speech
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }

        speakerBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            speakerOnIcon.classList.toggle('hidden', isMuted);
            speakerOffIcon.classList.toggle('hidden', !isMuted);
            if (isMuted) {
                speechSynthesis.cancel();
            }
        });

        // --- SPEECH-TO-TEXT (STT) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                recognition.start();
            });

            recognition.onstart = () => {
                micBtn.classList.add('mic-listening', 'bg-purple-600');
            };

            recognition.onend = () => {
                micBtn.classList.remove('mic-listening', 'bg-purple-600');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                // Automatically submit the form
                chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                micBtn.classList.remove('mic-listening');
            };

        } else {
            micBtn.style.display = 'none';
            console.log("Speech Recognition not supported in this browser.");
        }

        // --- Core Chat Logic ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                addMessage(message, 'user');
                userInput.value = '';
                getAiResponseFromServer(message);
            }
        });

        function addMessage(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-animation');
            
            if (sender === 'user') {
                messageElement.className += ' flex items-start gap-3 justify-end';
                messageElement.innerHTML = `<div class="bg-indigo-600/80 text-white p-3 rounded-lg rounded-br-none max-w-md shadow-lg border border-white/20"><p>${message}</p></div>`;
            } else { // AI message
                messageElement.className += ' flex items-start gap-3';
                messageElement.innerHTML = `
                    <div class="bg-purple-500/50 text-white p-2 rounded-full flex-shrink-0 shadow-lg border border-white/20">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg rounded-tl-none max-w-md shadow-md border border-white/10">
                        <p class="text-white/90">${message.replace(/\n/g, '<br>')}</p>
                    </div>`;
                speakText(message); // Speak the AI's response
            }
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showThinkingIndicator() {
            // ... (code is unchanged)
        }
        function removeThinkingIndicator() {
            // ... (code is unchanged)
        }

        async function getAiResponseFromServer(question) {
            submitButton.disabled = true;
            userInput.disabled = true;
            micBtn.disabled = true;
            showThinkingIndicator();

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: question })
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                
                const data = await response.json();
                removeThinkingIndicator();
                addMessage(data.response || "Sorry, I received an empty response.", 'ai');

            } catch (error) {
                console.error("Error connecting to backend:", error);
                removeThinkingIndicator();
                addMessage("plese connect me?", 'ai');
            } finally {
                submitButton.disabled = false;
                userInput.disabled = false;
                micBtn.disabled = false;
                userInput.focus();
            }
        }
    </script>
</body>

</html>

